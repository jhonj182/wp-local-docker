#!/bin/bash
set -e

# =============================================
# wp_install - Crear sitio WordPress local
# Uso: wp_install nombre-del-sitio
# Resultado: http://nombre-del-sitio.test
# =============================================

# ContraseÃ±a root de MariaDB (debe coincidir con docker-compose.yml base)
DB_ROOT_PASSWORD="wp_root_secret_2024"

# Colores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# Validar argumento
if [ -z "$1" ]; then
    echo -e "${RED}Error: Debes especificar un nombre para el sitio${NC}"
    echo -e "Uso: ${CYAN}wp_install mi-sitio${NC}"
    echo -e "Resultado: ${GREEN}http://mi-sitio.test${NC}"
    exit 1
fi

SITE_NAME="$1"
SITE_DIR="$HOME/wp-sites/$SITE_NAME"
DOMAIN="${SITE_NAME}.test"
DB_NAME="wp_${SITE_NAME//-/_}"
DB_USER="wp_${SITE_NAME//-/_}"
DB_PASSWORD=$(openssl rand -hex 12)

# Verificar que no exista
if [ -d "$SITE_DIR" ]; then
    echo -e "${RED}Error: El sitio '$SITE_NAME' ya existe en $SITE_DIR${NC}"
    exit 1
fi

# Verificar que Docker estÃ© corriendo
if ! docker info > /dev/null 2>&1; then
    echo -e "${RED}Error: Docker no estÃ¡ corriendo. Ejecuta: sudo systemctl start docker${NC}"
    exit 1
fi

# Verificar que la infraestructura base estÃ© corriendo
if ! docker ps --format '{{.Names}}' | grep -q 'wp-mariadb'; then
    echo -e "${YELLOW}La infraestructura base no estÃ¡ corriendo. LevantÃ¡ndola...${NC}"
    cd ~/wp-sites && docker compose up -d
    echo -e "${YELLOW}â³ Esperando a que MariaDB estÃ© listo...${NC}"
    sleep 10
fi

if ! docker ps --format '{{.Names}}' | grep -q 'wp-traefik'; then
    echo -e "${RED}Error: Traefik no estÃ¡ corriendo. Ejecuta: cd ~/wp-sites && docker compose up -d${NC}"
    exit 1
fi

echo -e "${CYAN}ğŸš€ Creando sitio WordPress: ${GREEN}http://$DOMAIN${NC}"
echo ""

# Crear base de datos y usuario en MariaDB
echo -e "${YELLOW}ğŸ—„ï¸  Creando base de datos y usuario...${NC}"
docker exec wp-mariadb mariadb -uroot -p"${DB_ROOT_PASSWORD}" -e "
    CREATE DATABASE IF NOT EXISTS \`${DB_NAME}\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
    CREATE USER IF NOT EXISTS '${DB_USER}'@'%' IDENTIFIED BY '${DB_PASSWORD}';
    GRANT ALL PRIVILEGES ON \`${DB_NAME}\`.* TO '${DB_USER}'@'%';
    FLUSH PRIVILEGES;
"

# Crear directorio del sitio
mkdir -p "$SITE_DIR/wp-content"

# Crear docker-compose.yml del sitio
cat > "$SITE_DIR/docker-compose.yml" <<COMPOSE
services:
  wordpress:
    image: wordpress:latest
    container_name: wp-${SITE_NAME}
    restart: unless-stopped
    environment:
      WORDPRESS_DB_HOST: wp-mariadb:3306
      WORDPRESS_DB_USER: ${DB_USER}
      WORDPRESS_DB_PASSWORD: ${DB_PASSWORD}
      WORDPRESS_DB_NAME: ${DB_NAME}
    volumes:
      - wp_data:/var/www/html
      - ./wp-content:/var/www/html/wp-content
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${SITE_NAME}.rule=Host(\`${DOMAIN}\`)"
      - "traefik.http.routers.${SITE_NAME}.entrypoints=web"
      - "traefik.http.services.${SITE_NAME}.loadbalancer.server.port=80"
    networks:
      - wp-network

volumes:
  wp_data:
    name: ${SITE_NAME}_wp_data

networks:
  wp-network:
    external: true
COMPOSE

# Crear archivo de info del sitio
cat > "$SITE_DIR/.site-info" <<INFO
SITE_NAME=${SITE_NAME}
DOMAIN=${DOMAIN}
DB_NAME=${DB_NAME}
DB_USER=${DB_USER}
DB_PASSWORD=${DB_PASSWORD}
CREATED=$(date '+%Y-%m-%d %H:%M:%S')
INFO

# Levantar el sitio
echo -e "${YELLOW}ğŸ“¦ Descargando WordPress y levantando contenedor...${NC}"
cd "$SITE_DIR"
docker compose up -d

# Esperar a que WordPress estÃ© listo
echo -e "${YELLOW}â³ Esperando a que WordPress estÃ© listo...${NC}"
for i in $(seq 1 30); do
    if curl -s -o /dev/null -w "%{http_code}" "http://${DOMAIN}" 2>/dev/null | grep -qE "200|302"; then
        break
    fi
    sleep 2
    echo -n "."
done
echo ""

# Resultado
echo ""
echo -e "${GREEN}âœ… Â¡Sitio creado exitosamente!${NC}"
echo ""
echo -e "  ğŸŒ URL:          ${CYAN}http://${DOMAIN}${NC}"
echo -e "  ğŸ”§ WP Admin:     ${CYAN}http://${DOMAIN}/wp-admin${NC}"
echo -e "  ğŸ—„ï¸  phpMyAdmin:   ${CYAN}http://pma.test${NC}"
echo -e "  ğŸ“ Archivos:     ${CYAN}${SITE_DIR}/wp-content${NC}"
echo ""
echo -e "  ğŸ“Š Base de datos:"
echo -e "     DB Name:      ${CYAN}${DB_NAME}${NC}"
echo -e "     DB User:      ${CYAN}${DB_USER}${NC}"
echo -e "     DB Password:  ${CYAN}${DB_PASSWORD}${NC}"
echo ""
echo -e "${YELLOW}Abre ${CYAN}http://${DOMAIN}${YELLOW} en tu navegador para completar la instalaciÃ³n de WordPress.${NC}"
echo ""
